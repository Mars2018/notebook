tips：
---
域名的层级结构：主机名.次级域名.顶机域名.根域名（www.alwayscoding.cn.root）(bbs.alwayscoding.cn.root)

HTTP：
---
不缓存

Cache-control：http 1.1 添加，缓存控制行，`cache-control: no-cache, no-store, must-revalidate`;
Progma: http 1.0 备注行， 可选： `progma:no-cache`,可兼容http 1.0;
Expire:设置缓存的过期时间，将其设置为 `expire:-1`可以使缓存立即失效，以达到不缓存的目的。

一个网络包（从顶层用户层到底层物理层）包括：
---
- HTTP/FTP等数据包：请求头，HTTP包长度最长为4960字节，在应用层上传输；
- TCP包(TCP是面向字节流的)/UDP包：添加了对应端口信息，UDP数据包非常简单，"标头"部分一共只有8个字节，总长度不超过65535字节，TCP数据包没有长度限制，但一般不会超过IP包的长度，以避免被分割，TCP/UDP包在传输层上传送；
- IP包：添加了IP地址对应信息，IP数据包的"标头"部分的长度为20到60字节，整个数据包的总长度最大为65535字节，IP包在网络层上传送；
- 以太网数据包：添加了对应MAC地址信息，数据包的"标头"部分长度18字节，单个包最长为1518字节，最短为64字节，所以一个IP包可能会分成几个以太网包，每一个最终的包，称为一个数据帧，在链路层上传送；
- 数据流信息：0或1，在物理层传送；

发送一条HTTP请求，全部步骤为：
---
1. 计算机向DHCP服务器（广播）发送DHCP请求包，获取一个IP,子网掩码，网关，DNS服务器信息，标识了在网络中的位置；
2. 计算机向DNS服务器发送DNS请求包，分析请求地址的IP地址；
3. 应用包装HTTP包->TCP包->IP包->数据帧，准备发送；
4. 将数据包发送到网关，由网关层层转发到对应的IP地址；
5. 对应HTTP服务器获取到包，解析端口信息，用对应有服务解析处理，并将响应信息同样包装；
6. 将响应信息原路返回；

流套接字和数据报套接字的区别：
---
- 流式套接字要分客户和服务器，而数据报不用分
- 流式套接字适合传输数据量大的，而数据报套接字适合传递数据量少的
- 流式套接字建立麻烦，数据报套接字建立简单
- 客户的流式套接字只能向一个方向传递，数据报套接字可以接受任何方向的来得数据，并可以向任何地址发送数据报
- 流套接字比数据报套接字好，这样你可以不必管理底层细节，只需要相信TCP就可以保证传送的数据是依次，可靠的传送的，缺点是效率相对数据报套接字低。
- 使用数据报套接字，可以让你更快，但你得自已保证数据是否依次，准确的传送来的，
如使用数据报套接字，你可能先收到后发的，后收到先发的，还有可能收漏，
- 数据报套接字是用来发送数据报的，是面向无连接不可靠的传输（在今天这个网络里，其实已经相当可靠）
- 流套接字是面向连接可靠的传输。服务器通过转发实现一个客户与另一个客户的数据传送。当向另一个客户转发时，他必须知道对方IP（或套接字等），所以要求转发的客户必须提供关于接受方的信息，否则服务器不知道向哪转发。

FTP的主动模式和被动模式：
---
FTP要使用两个TCP来建立连接，一个命令链路，用来传输客户端与服务器端之间的命令，通常为21端口；一个数据链路，用来上传或下载数据，通常为20端口；
根据命令链路的特点，FTP协议有两种工作模式，PORT模式（主动）和PASV模式（被动）；
主动模式建立：
	1. 客户端使用任意非特权端口N（大于1024）连接到服务器的21端口，并发送PORT:N+1到命令端口；
	2. 服务器的21端口，向客户端的N端口确认连接；
	3. 服务器的20端口向客户端的N+1端口传输数据；
	4. 客户端的N+1商品向服务器的20商品返回ACK确认包；
	客户端使用代理时无法使用主动模式，因为服务器端会向代理服务器发送数据；
被动模式建立：
	1. 客户端使用任意非特权端口N向服务器的20端口发起连接，并发送PASV命令到命令商品；
	2. 服务器开启一个非特权端口M，并发送PORT:M向客户端；
	3. 客户端的N+1端口向服务器的M端口发起连接请求；
	4. 服务器与客户端传输数据；

TCP/IP 协议
---
- TCP/IP是一个协议簇，包括STMP等协议，主要包括TCP和IP协议；
- TCP：Transmission Control Protocol 是一个可靠的、基于连接的、面向数据流的全双工协议。TCP 能够保障所有的数据包是按照其发送顺序而接收的。如果任意数据包在通讯时丢失，TCP 将自动重发数据包直到目标主机应答已接收。因为可靠性和性能的原因，TCP 在数据传输层使用 8bit 字节边界。因此，TCP 应用程序必须允许传送部分报文的可能。
面向连接，连接过程中要经过三次握手，结束连接要经过四次挥手；
	其传输数据对系统资源需求较多（头20字节），在服务端收到数据时要返回ACK确认标志，如一段时间内没有收到标识，需要重发报文；
	但其数据能保证正确性，包括重发和确认，包排序等；
- UDP：udp User Datagram Protocol 是一个无连接的、不可靠的、具有固定最大长度的报文协议。由于这些特性，UDP 协议拥有最小的协议开销。
不基于连接，连接直接传输数据，无法保证数据正确性，可能丢包；程序结构较简单（头8字节）
- icmp Internet Control Message Protocol 主要用于网关和主机报告错误的数据通信。例如"ping"命令（在目前大部分的操作系统中）就是使用 ICMP 协议实现的。

通信方式 套接字
---
定义：

socket，即套接字是一种通信机制，凭借这种机制，客户/服务器（即要进行通信的进程）系统的开发工作既可以在本地单机上进行，也可以跨网络进行。也就是说它可以让不在同一台计算机但通过网络连接计算机上的进程进行通信。也因为这样，套接字明确地将客户端和服务器区分开来。
socket就如其意思，为插座，接口，服务器和客户端各创建一个“接口”，将两个接口对接，连成一条通道，通过此通道传送数据；

三个重要属性：

- 域：AF_INET 网络套接字：通过IP和端口来确定一个接口；AF_UNIX UNIX套接字，通过一个文件来确定接口
- 套接字类型：SOCK_STREAM 流：面向连接，通过TCP/IP协议实现；SOCK_DGRAM 数据报：不面向连接，通过UDP协议实现；对数据长度有限制；SOCK_RAW 原始数据
- 套接字协议：特定协议，TCP/UDP等；IPPROTO_TCP：TCP  IPPROTO_SCTP：SCTP传输协议

建立一个连接：

服务器端：
1. 调用socket()创建一个连接；`int socket(int domain, int type, int protocol); `
2. 调用bind()给套接字命名；`int bind( int socket, const struct sockaddr *address, size_t address_len);`
3. 调用listen()监听此套接字；`int listen(int socket, int backlog);  `
4. 调用accept()接受客户端的连接；`int accept(int socket, struct sockaddr *address, size_t *address_len); `
客户端：
1. 调用socket()创建一个连接；
2. 调用connect()连接服务器端的套接字；`int connect(int socket, const struct sockaddr *address, size_t address_len); `
3. 调用close()关闭连接： `int close(int fd);`
数据交互：`write() read() send() recv()  sendto() recvfrom() sendmsg() recvmsg()`

可用的地址/协议 Domain 描述
   *AF_INET IPv4 网络协议。TCP 和 UDP 都可使用此协议。
    AF_INET6 IPv6 网络协议。TCP 和 UDP 都可使用此协议。
    AF_UNIX 本地通讯协议。具有高性能和低成本的 IPC（进程间通讯）。

   *SOCK_STREAM 提供一个顺序化的、可靠的、全双工的、基于连接的字节流。支持数据传送流量控制机制。TCP 协议即基于这种流式套接字。
    SOCK_DGRAM 提供数据报文的支持。(无连接，不可靠、固定最大长度).UDP协议即基于这种数据报文套接字。
    SOCK_SEQPACKET 提供一个顺序化的、可靠的、全双工的、面向连接的、固定最大长度的数据通信；数据端通过接收每一个数据段来读取整个数据包。
    SOCK_RAW 提供读取原始的网络协议。这种特殊的套接字可用于手工构建任意类型的协议。一般使用这个套接字来实现 ICMP 请求（例如 ping）。
    SOCK_RDM 提供一个可靠的数据层，但不保证到达顺序。一般的操作系统都未实现此功能。

 protocol 参数，是设置指定 domain 套接字下的具体协议。这个值可以使用 getprotobyname() 函数进行读取。如果所需的协议是 TCP 或 UDP，可以直接使用常量 SOL_TCP 和 SOL_UDP 。

CDN负载均衡
-------
1. DNS负载均衡：维护一个IP库，在各个DNS中将域名解析到不同的IP。客户端发起时查询自己附近的DNS服务器，获取到最近的IP，访问到不同的服务器；精度低，依赖用户的DNS服务器配置。
2. HTTPDNS：单一域名和IP，用户访问时根据用户IP获取用户大概位置，然后再分发频道

CGI协议：
---
common gateway interface 协议：是服务器与解释器交互的接口，服务器负责受理请求，并将请求信息解释为“元数据”，传送给解释器来解释执行；
常见规范（只考虑 MUST）如下：
CGI请求：
- 服务器根据 以 '/' 分隔的路径选择解释器；
- 如果有`AUTH`字段，需要先执行AUTH，再执行解释器；
 服务器确认`CONTENT-LENGTH`表示的是数据解析出来的长度，如果附带信息体，则必须将长度字段传送到解释器；
- 如果有`CONTENT-TYPE`字段，服务器必须将其传给解释器；若无字段，但有信息体，则服务器判断此类型或抛弃信息体；
- 服务器必须设置 `QUERY_STRING`字段，如果客户端没有设置，服务端要传一个空字符串“”
- 服务器必须设置`REMOTE_ADDR`，即客户端请求IP；
- `REQUEST_METHOD`字段必须设置， GET POST 等，大小写敏感；
- `SCRIPT_NAME` 表示执行的解释器脚本名，必须设置；
- `SERVER_NAME`和`SERVER_PORT`代表着大小写敏感的服务器名和服务器受理时的TCP/IP端口；
- `SERVER_PROTOCOL`字段指示着服务器与解释器协商的协议类型，不一定与客户端请求的SCHEMA相同，如'https://'可能为HTTP；
- 在`CONTENT-LENGTH`不为NULL时，服务器要提供信息体，此信息体要严格与长度相符，即使有更多的可读信息也不能多传；服务器必须将数据压缩等编码解析出来；

CGI响应：
- CGI解释器必须响应 至少一行头 + 换行 + 响应内容；
- 解释器在响应文档时，必须要有`CONTENT-TYPE`头；
- 在客户端重定向时，解释器除了`client-redir-response`= 绝对url地址，不能再有其他返回。然后服务器返回一个 302 状态码；
- 解释器响应 三位数字状态码，具体配置见搜索；
- 服务器必须将所有解释器返回的数据响应给客户端，除非需要压缩等编码，服务器不能修改响应数据；

IP地址表示法
---
- 192.168.1.1 指示一个精准IP地址。
但一个IP地址会分为网络位和主机位，表示位 ` xxx.xxx.xxx.xxx/N `。其中N表示网络位长度。
除去网络位外的后面位数是主机位。网络位越短，后面的主机位就会越多，局域网内所能容纳的主机就会越多。

负载均衡
---
- 分类 四层负载均衡：OSI模型中的传输层；七层负载均衡：OSI模型中的应用层；
- 四层负载均衡：主要根据报文中的目标地址和端口，修改报文的目标IP和源IP直接转发到目标服务器，其握手等操作由目标服务器与客户端进行；更适用于基于TCP的C/S系统；
- 七层负载均衡：中间的负载均衡服务器类似于代理，可以在业务上对请求进行分发；客户端与负载均衡服务器握手连接，然后负载均衡服务器再与目标服务器通信，虽然转发效率低，但更智能化；而且安全性上，可以在负载均衡服务器上进行安全拦截，后端服务器还是安全的，适用于基于HTTP的B/S系统；
- 常用的负载均衡算法：随机算法；轮询和加权轮询（往目标服务器分发请求直到效率开始降低）；哈希算法（ip/url）；

NAT Net Address Transform
---
在一个网络组织的出口处，通过替换ip报文头部的地址信息，将内部网络地址替换为出口IP地址提供公网可达性和上层协议连接能力，大大地缓解了IP地址的短缺问题。
- 网络被分为公网和私网两个部分，NAT网关设置在私网到公网的路由出口位置，双向流量必须都要经过NAT网关；
- 网络访问只能先由私网侧发起，公网无法主动访问私网地址；
- NAT网关的存在对通信双方都是透明的；
- NAT网关在两个访问方向上完成两次地址的转换或翻译，出方向做源信息替换，入方向做目的信息替换；
- NAT网关为了实现双向翻译的功能，需要维护一张关联表，保存对应的会话信息。

队首阻塞
---
定义：（Head-of-line blocking或缩写为HOL blocking）由于队首的第一个数据包受阻而导致整队数据包阻塞。
问题：交换机，TCP，HTTP都可能出现此问题。
解决：解决此问题可以使用虚拟队列，消除队列数据对队首处理状态的依赖，HTTP可以使用管道化请求，将幂等请求管道化，而HTTP2则使用虚拟流，一个tcp连接上建立多个http流。

服务器负载均衡
-------
负载均衡分为硬件和软件：
- 硬件：F5 的 BIG-IP、Citrix 的 NetScaler，能同时提供四层和七层负载均衡；
- 软件：基于TCP、HTTP协议，有四层(LVS,HaProxy,Nginx),七层(HaProxy,Nginx,ATS等)

LVS: 工作在四层，实现和 iptables 和 netfilter 类似，工作在内核的 TCP/IP 协议栈上，可以强行修改报文，将数据发给后端主机。
常用的设备地址：
- VIP：Virtual IP，LVS 面向用户请求的 IP 地址
- RIP：Real server IP，后端服务器用于和 LVS 通信的 IP 地址
- DIP：Director IP，LVS 用户和后端服务器通信的 IP 地址
- CIP：Client IP，客户端 IP 地址